.PHONY: help start stop restart status logs dev test clean install install-deps install-playwright check-deps docker-up docker-down docker-restart

# Variables
# Utilise 'docker compose' (V2) - fallback automatique vers 'docker-compose' si nÃ©cessaire
DOCKER_COMPOSE = docker compose -f docker/docker-compose.yml
PYTHON = python
UV = uv
UVICORN = $(UV) run uvicorn python_scripts.api.main:app
PORT = 8000
HOST = 0.0.0.0
VENV_BIN = .venv/bin

help: ## Affiche cette aide
	@echo "Commandes disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Installe les dÃ©pendances
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	uv pip install -e ".[dev]"
	@echo "ğŸ­ Installation de Playwright..."
	@if command -v playwright > /dev/null 2>&1; then \
		playwright install chromium; \
	elif [ -f "$(VENV_BIN)/playwright" ]; then \
		$(VENV_BIN)/playwright install chromium; \
	else \
		$(UV) run playwright install chromium; \
	fi
	@echo "âœ… Installation terminÃ©e"

install-deps: ## Installe uniquement les dÃ©pendances (sans dev)
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	uv pip install -e .
	@echo "ğŸ­ Installation de Playwright..."
	@if command -v playwright > /dev/null 2>&1; then \
		playwright install chromium; \
	elif [ -f "$(VENV_BIN)/playwright" ]; then \
		$(VENV_BIN)/playwright install chromium; \
	else \
		$(UV) run playwright install chromium; \
	fi
	@echo "âœ… Installation terminÃ©e"

install-playwright: ## Installe uniquement Playwright/Chromium
	@echo "ğŸ­ Installation de Playwright/Chromium..."
	@if command -v playwright > /dev/null 2>&1; then \
		playwright install chromium; \
	elif [ -f "$(VENV_BIN)/playwright" ]; then \
		$(VENV_BIN)/playwright install chromium; \
	else \
		$(UV) run playwright install chromium; \
	fi
	@echo "âœ… Playwright installÃ©"

docker-up: ## DÃ©marre les services Docker (PostgreSQL, Qdrant, Ollama)
	@echo "ğŸ³ DÃ©marrage des services Docker..."
	$(DOCKER_COMPOSE) up -d
	@echo "â³ Attente du dÃ©marrage des services..."
	@sleep 5
	@echo "âœ… Services Docker dÃ©marrÃ©s"

docker-down: ## ArrÃªte les services Docker
	@echo "ğŸ³ ArrÃªt des services Docker..."
	$(DOCKER_COMPOSE) down
	@echo "âœ… Services Docker arrÃªtÃ©s"

docker-restart: ## RedÃ©marre les services Docker
	@echo "ğŸ”„ RedÃ©marrage des services Docker..."
	$(DOCKER_COMPOSE) restart
	@echo "âœ… Services Docker redÃ©marrÃ©s"

docker-logs: ## Affiche les logs des services Docker
	$(DOCKER_COMPOSE) logs -f

docker-status: ## Affiche le statut des services Docker
	$(DOCKER_COMPOSE) ps

init-db: ## Initialise la base de donnÃ©es (migrations)
	@echo "ğŸ—„ï¸  Initialisation de la base de donnÃ©es..."
	@if [ -f "$(VENV_BIN)/alembic" ]; then \
		$(VENV_BIN)/alembic upgrade head; \
	else \
		$(UV) run alembic upgrade head; \
	fi
	@echo "âœ… Base de donnÃ©es initialisÃ©e"

init-qdrant: ## Initialise la collection Qdrant
	@echo "ğŸ” Initialisation de Qdrant..."
	@if [ -f "$(VENV_BIN)/python" ]; then \
		$(VENV_BIN)/python scripts/init_qdrant.py; \
	else \
		$(UV) run python scripts/init_qdrant.py; \
	fi
	@echo "âœ… Qdrant initialisÃ©"

check-deps: ## VÃ©rifie et installe les dÃ©pendances manquantes
	@echo "ğŸ” VÃ©rification des dÃ©pendances..."
	@uv pip install -e . --quiet || echo "âš ï¸  Certaines dÃ©pendances peuvent Ãªtre manquantes"
	@echo "ğŸ­ VÃ©rification de Playwright..."
	@if ! command -v playwright > /dev/null 2>&1 && [ ! -f "$(VENV_BIN)/playwright" ]; then \
		echo "âš ï¸  Playwright non trouvÃ©. ExÃ©cutez: make install-playwright"; \
	fi
	@echo "âœ… VÃ©rification terminÃ©e"

start: check-deps ## DÃ©marre l'API FastAPI
	@echo "ğŸš€ DÃ©marrage de l'API..."
	$(UVICORN) --reload --host $(HOST) --port $(PORT)

start-prod: ## DÃ©marre l'API en mode production
	@echo "ğŸš€ DÃ©marrage de l'API (production)..."
	$(UVICORN) --host $(HOST) --port $(PORT) --workers 4

stop: ## ArrÃªte l'API (trouve et tue le processus)
	@echo "ğŸ›‘ ArrÃªt de l'API..."
	@pkill -f "uvicorn python_scripts.api.main:app" || echo "Aucun processus trouvÃ©"
	@pkill -f "uv run uvicorn" || true

restart: stop start ## RedÃ©marre l'API (arrÃªte puis dÃ©marre)

status: ## Affiche le statut de l'application
	@echo "ğŸ“Š Statut de l'application:"
	@echo ""
	@echo "Services Docker:"
	@$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "Processus API:"
	@pgrep -f "uvicorn python_scripts.api.main:app\|uv run uvicorn" > /dev/null && echo "âœ… API en cours d'exÃ©cution" || echo "âŒ API arrÃªtÃ©e"
	@echo ""
	@echo "Port $(PORT):"
	@lsof -i :$(PORT) > /dev/null 2>&1 && echo "âœ… Port $(PORT) utilisÃ©" || echo "âŒ Port $(PORT) libre"

logs: ## Affiche les logs de l'API (si en arriÃ¨re-plan)
	@tail -f logs/app.log 2>/dev/null || echo "Aucun fichier de log trouvÃ©"

dev: docker-up init-db start ## Mode dÃ©veloppement complet (Docker + DB + API)

test: ## Lance les tests
	@echo "ğŸ§ª ExÃ©cution des tests..."
	@if [ -f "$(VENV_BIN)/pytest" ]; then \
		$(VENV_BIN)/pytest; \
	else \
		$(UV) run pytest; \
	fi

test-cov: ## Lance les tests avec couverture
	@echo "ğŸ§ª ExÃ©cution des tests avec couverture..."
	@if [ -f "$(VENV_BIN)/pytest" ]; then \
		$(VENV_BIN)/pytest --cov=python_scripts --cov-report=html --cov-report=term; \
	else \
		$(UV) run pytest --cov=python_scripts --cov-report=html --cov-report=term; \
	fi

clean: ## Nettoie les fichiers temporaires
	@echo "ğŸ§¹ Nettoyage..."
	find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -r {} + 2>/dev/null || true
	rm -rf .pytest_cache .mypy_cache .ruff_cache htmlcov 2>/dev/null || true
	@echo "âœ… Nettoyage terminÃ©"

setup: install docker-up init-db init-qdrant ## Configuration complÃ¨te (install + Docker + DB + Qdrant)

reset: docker-down clean ## RÃ©initialise tout (arrÃªte Docker + nettoie)

# Commandes Makefile disponibles
# make help â€” Affiche toutes les commandes
# make dev â€” DÃ©marrage complet (Docker + DB + API)
# make start â€” DÃ©marre l'API
# make restart â€” RedÃ©marre l'API
# make stop â€” ArrÃªte l'API
# make status â€” Affiche le statut
# make docker-up â€” DÃ©marre les services Docker
# make docker-down â€” ArrÃªte les services Docker
# make docker-restart â€” RedÃ©marre les services Docker
# make docker-logs â€” Affiche les logs Docker
# make test â€” Lance les tests
# make clean â€” Nettoie les fichiers temporaires
# Option 1: Avec vÃ©rification automatique des dÃ©pendances
# make start

# # Option 2: Installer toutes les dÃ©pendances d'abord
# make install
# make start

# # Option 3: VÃ©rifier manuellement
# make check-deps
# make start